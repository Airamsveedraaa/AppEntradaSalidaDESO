<Window x:Class="AppEntradaSalidaDESO.Views.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:AppEntradaSalidaDESO"
        xmlns:vm="clr-namespace:AppEntradaSalidaDESO.ViewModels"
        xmlns:conv="clr-namespace:AppEntradaSalidaDESO.Converters"
        xmlns:controls="clr-namespace:AppEntradaSalidaDESO.Controls"
        mc:Ignorable="d"
        Title="Simulador de Planificación de Discos - DESO" Height="750" Width="1100"
        WindowStartupLocation="CenterScreen">
    
    <Window.Resources>
        <!-- Estilo básico para TextBoxes con Header -->
        <Style TargetType="TextBlock" x:Key="LabelStyle">
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Margin" Value="0,10,0,5"/>
            <Setter Property="FontSize" Value="14"/>
        </Style>
        
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>
        <conv:InverseBooleanConverter x:Key="InverseBool"/>
        <conv:InverseBooleanToVisibilityConverter x:Key="InverseBoolToVis"/>
    </Window.Resources>

    <Grid Margin="20">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="380"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <!-- Panel de Configuración -->
        <Border Grid.Column="0" Background="#F5F5F5" Padding="15" CornerRadius="8">
            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <StackPanel>
                    <Grid Margin="0,0,0,15">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="Configuración del Ejercicio" FontSize="20" FontWeight="Bold" VerticalAlignment="Center"/>
                        <Button Grid.Column="1" Command="{Binding OpenCalculatorCommand}" Content="🛠️ Conversor" Padding="8,4" Background="#EEE" BorderBrush="#AAA"/>
                    </Grid>

                    <!-- Algoritmo -->
                    <TextBlock Text="Algoritmo" Style="{StaticResource LabelStyle}"/>
                    <ComboBox ItemsSource="{Binding Algorithms}" 
                              SelectedItem="{Binding SelectedAlgorithmName}"
                              Padding="10" FontSize="14"/>

                    <!-- N Step (Condicional) -->
                    <StackPanel Visibility="{Binding IsScanNSelected, Converter={StaticResource BoolToVis}}">
                        <TextBlock Text="Tamaño del paso (N)" Style="{StaticResource LabelStyle}"/>
                        <TextBox Text="{Binding NStep}" Padding="5" FontSize="14" ToolTip="Número de peticiones a atender por lote"/>
                    </StackPanel>

                    <!-- Configuración de Llegadas -->
                    <CheckBox Content="¿Peticiones llegan en distintos instantes?" 
                              IsChecked="{Binding IsDynamicArrivals}" 
                              Margin="0,15,0,5" FontWeight="SemiBold"/>

                    <!-- MODO SIMPLE -->
                    <StackPanel Visibility="{Binding IsDynamicArrivals, Converter={StaticResource InverseBoolToVis}}">
                        <TextBlock Text="Peticiones (separadas por comas)" Style="{StaticResource LabelStyle}"/>
                        <TextBox Text="{Binding RequestsInput, UpdateSourceTrigger=PropertyChanged}" 
                                 Padding="5" FontSize="14" Height="60" TextWrapping="Wrap"
                                 ToolTip="Ejemplo: 98, 183, 37, 122, 14, 124, 65, 67"/>
                    </StackPanel>

                    <!-- MODO DINÁMICO -->
                    <StackPanel Visibility="{Binding IsDynamicArrivals, Converter={StaticResource BoolToVis}}">
                        <Border Background="#F0F8FF" BorderBrush="#ADD8E6" BorderThickness="1" CornerRadius="5" Padding="10" Margin="0,5,0,0">
                            <StackPanel>
                                <TextBlock Text="Añadir Grupo de Peticiones" FontWeight="Bold" Margin="0,0,0,5"/>
                                
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="80"/>
                                        <ColumnDefinition Width="10"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <StackPanel Grid.Column="0">
                                        <TextBlock Text="Instante (ms)" FontSize="10"/>
                                        <TextBox Text="{Binding NewArrivalInstant}" Padding="3"/>
                                    </StackPanel>
                                    <StackPanel Grid.Column="2">
                                        <TextBlock Text="Pistas (sep. por comas)" FontSize="10"/>
                                        <TextBox Text="{Binding NewArrivalTracks, UpdateSourceTrigger=PropertyChanged}" Padding="3"/>
                                    </StackPanel>
                                </Grid>
                                <Button Content="+ Añadir Grupo" Command="{Binding AddArrivalGroupCommand}" Margin="0,5,0,0" Padding="5,2"/>

                                <!-- Lista de Grupos -->
                                <TextBlock Text="Grupos Configurados:" FontWeight="SemiBold" Margin="0,10,0,2"/>
                                <ItemsControl ItemsSource="{Binding ArrivalGroups}" MaxHeight="100">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border Background="White" BorderBrush="#EEE" BorderThickness="1" Margin="0,0,0,2" Padding="5">
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="*"/>
                                                        <ColumnDefinition Width="Auto"/>
                                                    </Grid.ColumnDefinitions>
                                                    <TextBlock>
                                                        <Run Text="T=" FontWeight="Bold"/><Run Text="{Binding ArrivalTime}" FontWeight="Bold"/>
                                                        <Run Text=": "/>
                                                        <Run Text="{Binding TracksInput}"/>
                                                    </TextBlock>
                                                    <Button Grid.Column="1" Content="❌" 
                                                            Command="{Binding DataContext.RemoveArrivalGroupCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}" 
                                                            CommandParameter="{Binding}"
                                                            Background="Transparent" BorderThickness="0" Foreground="Red" Cursor="Hand"/>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                    <ItemsControl.Template>
                                        <ControlTemplate TargetType="ItemsControl">
                                            <ScrollViewer VerticalScrollBarVisibility="Auto" MaxHeight="100">
                                                <ItemsPresenter/>
                                            </ScrollViewer>
                                        </ControlTemplate>
                                    </ItemsControl.Template>
                                </ItemsControl>
                            </StackPanel>
                        </Border>
                    </StackPanel>

                    <!-- Configuración del Disco -->
                    <TextBlock Text="Configuración del Disco" FontSize="16" FontWeight="Bold" Margin="0,15,0,5" Foreground="#007ACC"/>
                    
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="10"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        
                        <StackPanel Grid.Column="0">
                            <TextBlock Text="Min Cilindro" Style="{StaticResource LabelStyle}"/>
                            <TextBox Text="{Binding MinCylinder}" Padding="5" FontSize="14"/>
                        </StackPanel>

                        <StackPanel Grid.Column="2">
                            <TextBlock Text="Max Cilindro" Style="{StaticResource LabelStyle}"/>
                            <TextBox Text="{Binding MaxCylinder}" Padding="5" FontSize="14"/>
                        </StackPanel>
                    </Grid>

                    <TextBlock Text="Posición Inicial Cabezal" Style="{StaticResource LabelStyle}"/>
                    <TextBox Text="{Binding InitialPosition}" Padding="5" FontSize="14"/>

                    <!-- Dirección (Condicional) -->
                    <StackPanel Visibility="{Binding IsDirectionRequired, Converter={StaticResource BoolToVis}}">
                        <TextBlock Text="Dirección Inicial" Style="{StaticResource LabelStyle}"/>
                        <ComboBox SelectedItem="{Binding SelectedDirection}" Padding="10" FontSize="14">
                            <System:String xmlns:System="clr-namespace:System;assembly=mscorlib">up</System:String>
                            <System:String xmlns:System="clr-namespace:System;assembly=mscorlib">down</System:String>
                        </ComboBox>
                    </StackPanel>

                    <!-- Configuración de Tiempo (Unificada - Estilo Web) -->
                    <GroupBox Header="Configuración de Tiempo y Costes" Margin="0,15,0,0" Padding="10" BorderBrush="#CCC">
                        <StackPanel>
                            <!-- Checkbox para usar specs avanzadas -->
                            <CheckBox Content="Usar Especificaciones Avanzadas de Disco" 
                                      IsChecked="{Binding UseAdvancedSpecs}"
                                      Margin="0,0,0,10" FontWeight="SemiBold"/>

                            <!-- Configuración SIMPLE (Visible si NO usa avanzadas) -->
                            <StackPanel Visibility="{Binding UseAdvancedSpecs, Converter={StaticResource InverseBoolToVis}}">
                                <!-- Tiempo por Pista -->
                                <TextBlock Text="Tiempo por Pista (ms)" Style="{StaticResource LabelStyle}" Margin="0,0,0,3"/>
                                <TextBox Text="{Binding TimePerTrack}" Padding="5" FontSize="14"/>
                                <TextBlock Text="Coste por mover 1 pista (búsqueda)" FontSize="10" Foreground="#666" Margin="0,2,0,10"/>
                                
                                <!-- Tiempo por Solicitud -->
                                <TextBlock Text="Tiempo por Petición (ms)" Style="{StaticResource LabelStyle}" Margin="0,0,0,3"/>
                                <TextBox Text="{Binding TimePerRequest}" Padding="5" FontSize="14"/>
                                <TextBlock Text="Coste fijo por atender cada solicitud" FontSize="10" Foreground="#666" Margin="0,2,0,5"/>
                            </StackPanel>

                            <!-- Configuración AVANZADA (Visible si SI usa avanzadas) -->
                            <StackPanel Visibility="{Binding UseAdvancedSpecs, Converter={StaticResource BoolToVis}}">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="10"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>

                                    <!-- Fila 1 -->
                                    <StackPanel Grid.Row="0" Grid.Column="0">
                                        <TextBlock Text="RPM" Margin="0,5,0,2"/>
                                        <TextBox Text="{Binding Rpm}" Padding="3"/>
                                    </StackPanel>
                                    <StackPanel Grid.Row="0" Grid.Column="2">
                                        <TextBlock Text="Sectores/Pista" Margin="0,5,0,2"/>
                                        <TextBox Text="{Binding SectorsPerTrack}" Padding="3"/>
                                    </StackPanel>

                                    <!-- Fila 2 -->
                                    <StackPanel Grid.Row="1" Grid.Column="0">
                                        <TextBlock Text="Caras" Margin="0,5,0,2"/>
                                        <TextBox Text="{Binding Faces}" Padding="3"/>
                                    </StackPanel>
                                    <StackPanel Grid.Row="1" Grid.Column="2">
                                        <TextBlock Text="Tamaño Sector" Margin="0,5,0,2"/>
                                        <TextBox Text="{Binding SectorSize}" Padding="3"/>
                                    </StackPanel>

                                    <!-- Fila 3 -->
                                    <StackPanel Grid.Row="2" Grid.ColumnSpan="3">
                                        <TextBlock Text="Tamaño Bloque (bytes)" Margin="0,5,0,2"/>
                                        <TextBox Text="{Binding BlockSize}" Padding="3"/>
                                    </StackPanel>
                                </Grid>
                                <TextBlock Text="*Calcula latencia y transferencia automáticamente" FontSize="10" Foreground="#007ACC" Margin="0,5,0,0" FontStyle="Italic"/>
                            </StackPanel>
                        </StackPanel>
                    </GroupBox>

                    <!-- Botón Ejecutar -->
                    <Button Command="{Binding ExecuteCommand}" 
                            Content="Simular" 
                            Margin="0,20,0,0" 
                            Padding="10" 
                            Background="#007ACC" 
                            Foreground="White" 
                            FontWeight="Bold" 
                            FontSize="16"
                            Cursor="Hand"/>
                </StackPanel>
            </ScrollViewer>
        </Border>

        <!-- Panel de Resultados -->
        <Grid Grid.Column="1" Margin="20,0,0,0">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/> <!-- Title -->
                <RowDefinition Height="250"/>  <!-- Visualization Graph -->
                <RowDefinition Height="150"/>  <!-- Text Output -->
                <RowDefinition Height="*"/>    <!-- DataGrid -->
            </Grid.RowDefinitions>

            <TextBlock Text="Resultados de la Simulación" FontSize="20" FontWeight="Bold" Margin="0,0,0,5"/>

            <!-- Visualization Graph -->
            <Border Grid.Row="1" Margin="0,0,0,10" BorderBrush="#EEE" BorderThickness="1" CornerRadius="5">
                <controls:TrackVisualizationControl 
                    Steps="{Binding VisualizationSteps}"
                    MaxTrack="{Binding MaxCylinder}"
                    MinTrack="{Binding MinCylinder}"
                    Background="White"/>
            </Border>

            <!-- Text Output -->
            <TextBox Grid.Row="2" 
                     Text="{Binding ResultOutput, Mode=OneWay}" 
                     IsReadOnly="True" 
                     VerticalScrollBarVisibility="Auto" 
                     FontFamily="Consolas" 
                     FontSize="13" 
                     Padding="10"
                     AcceptsReturn="True"
                     TextWrapping="Wrap"
                     Margin="0,0,0,10"/>
                     
            <!-- Table -->
            <DataGrid Grid.Row="3"
                      ItemsSource="{Binding StepsTable}"
                      AutoGenerateColumns="False"
                      CanUserAddRows="False"
                      IsReadOnly="True"
                      HeadersVisibility="Column"
                      GridLinesVisibility="Horizontal"
                      Background="White"
                      Padding="5">
                <DataGrid.Columns>
                    <!-- Columnas estilo referencia -->
                    <DataGridTextColumn Header="Instante" Binding="{Binding Instant, StringFormat=N2}" Width="60"/>
                    <DataGridTextColumn Header="Pendientes" Binding="{Binding Queue}" Width="200">
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="TextBlock">
                                <Setter Property="FontSize" Value="11"/>
                                <Setter Property="VerticalAlignment" Value="Center"/>
                                <Setter Property="TextWrapping" Value="Wrap"/>
                                <Setter Property="FontWeight" Value="SemiBold"/>
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>
                    
                    <DataGridTextColumn Header="Actual" Binding="{Binding From}" Width="60"/>
                    <DataGridTextColumn Header="Siguiente" Binding="{Binding To}" Width="70" FontWeight="Bold"/>
                    <DataGridTextColumn Header="Recorridas" Binding="{Binding Distance}" Width="70"/>
                    
                    <!-- Información extra útil que mantenemos -->
                    <DataGridTextColumn Header="Acumulado" Binding="{Binding Accumulator}" Width="70"/>
                    <DataGridTextColumn Header="Buffer (Lote)" Binding="{Binding Buffer}" Width="100">
                         <DataGridTextColumn.ElementStyle>
                            <Style TargetType="TextBlock">
                                <Setter Property="FontSize" Value="11"/>
                                <Setter Property="VerticalAlignment" Value="Center"/>
                                <Setter Property="Foreground" Value="#D2691E"/>
                                <Setter Property="TextWrapping" Value="Wrap"/>
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>
                    <DataGridTextColumn Header="Dirección" Binding="{Binding Direction}" Width="*"/>
                </DataGrid.Columns>
            </DataGrid>
        </Grid>
    </Grid>
</Window>
